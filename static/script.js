import{SocketHandler}from"./SocketHandler.js";function copyToClipboardLegacy(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function throttle(e,t){let n=0;return function(...a){const o=(new Date).getTime();if(!(o-n<t))return n=o,e(...a)}}document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".uuid-list"),t=document.getElementById("updateNicknameForm"),n=document.getElementById("updatennInput"),a=document.querySelector("#userSidebar .user-avatar"),o=document.getElementById("messages"),s=document.getElementById("messageInput");function i(e){return e>=1e9?(e/1e9).toFixed(1).replace(/\.0$/,"")+"B":e>=1e6?(e/1e6).toFixed(1).replace(/\.0$/,"")+"M":e>=1e5?Math.floor(e/1e3)+"K":e.toLocaleString("vi-VN")}const c=document.getElementById("heartIcon"),r=document.getElementById("eyeIcon");function l(){c.style.color="red",c.className="fa-solid fa-heart"}function d(){r.style.color="#593ceb",r.className="fa-solid fa-eye"}async function m(){try{c.onclick=null;const e=await fetch("https://emreview.duckdns.org/api/profile/like"),t=await e.json();c.classList.add("fill-heart-animation"),setTimeout((()=>{l(),document.getElementById("likes").innerText=i(t.likes),c.onclick=()=>{u()}}),1e3)}catch(e){console.error("Error incrementing like:",e.message)}}async function u(){try{c.onclick=null;const e=await fetch("https://emreview.duckdns.org/api/profile/dislike"),t=await e.json();c.classList.add("fill-heart-animation"),setTimeout((()=>{c.style.color="initial",c.className="fa-regular fa-heart",document.getElementById("likes").innerText=i(t.likes),c.onclick=()=>{m()}}),1e3)}catch(e){console.error("Error descending likes:",e.message)}}window.addEventListener("load",(async function(){try{const e=await fetch("https://emreview.duckdns.org/api/profile"),t=await e.json();t.viewed?d():async function(){try{const e=await fetch("https://emreview.duckdns.org/api/profile/view"),t=await e.json();r.classList.add("fill-eye-animation"),setTimeout((()=>{d(),document.getElementById("views").innerText=i(t.views)}),1e3)}catch(e){console.error("Error incrementing view:",e)}}(),t.liked?(l(),c.onclick=()=>{u()}):c.onclick=()=>{m()},document.getElementById("views").innerText=i(t.views),document.getElementById("likes").innerText=i(t.likes)}catch(e){console.error("Error incrementing like:",e)}})),document.getElementById("openTopModalBtn").addEventListener("mouseenter",(function(){this.querySelector("i").className="fa-duotone fa-regular fa-gear fa-spin"})),document.getElementById("openTopModalBtn").addEventListener("mouseleave",(function(){this.querySelector("i").className="fa-regular fa-gear"})),document.getElementById("openTopModalBtn").addEventListener("click",(()=>document.getElementById("topModal").classList.add("show"))),document.getElementById("closeModal").addEventListener("click",(()=>document.getElementById("topModal").classList.remove("show")));let g=null,y=JSON.parse(localStorage.getItem("userData")),v=null;document.getElementById("openChat").addEventListener("click",(()=>{v=v||("disable"===localStorage.getItem("enableNofity")?null:"Notification"in window?(Notification.requestPermission().then((e=>{"granted"===e?Toastify({text:E.notification_granted,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast():Toastify({text:E.notification_refused,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()})),{sendNotification:function(e,t,n){!document.hidden&&document.querySelector(".chat-box").classList.contains("open")||"granted"!==Notification.permission||(new Notification(e,{body:t,icon:n}).onclick=()=>window.focus())}}):null),document.querySelector(".chat-box").classList.add("open"),y&&""!==!y.clientId&&""!==y.nickname.trim()?g||(g=y.isAdmin?T():L()):(y={isAdmin:!1,clientId:"",nickname:"",avatar:null},document.getElementById("entryForm").style.display="flex",document.getElementById("userSidebar").style.display="none")}));const p=()=>{document.querySelector(".info-sidebar").classList.remove("show"),document.querySelector(".info-icon i").className="fa-regular fa-circle-info"};document.getElementById("closeChat").addEventListener("click",(()=>{document.querySelector(".chat-box").classList.remove("open"),document.querySelector(".chat-sidebar").classList.remove("show");const e=document.getElementById("toggleSidebar").querySelector("i");e.classList.remove("fa-chevron-left"),e.classList.add("fa-chevron-right"),p()})),window.showTerms=()=>document.getElementById("chatTerms").classList.add("show"),document.getElementById("entryForm").addEventListener("submit",(e=>{e.preventDefault(),y.isAdmin=!1;const t=document.getElementById("nicknameInput");if(!(""===t.value.trim()||t.value.length>25)){if(t.value.toLowerCase().includes("admin"))return t.setCustomValidity(E.verifyNickname_1),t.reportValidity(),void setTimeout((()=>{t.setCustomValidity("")}),3e3);if(t.value.toLowerCase().includes("thượng"))return t.setCustomValidity(E.verifyNickname_3),t.reportValidity(),void setTimeout((()=>{t.setCustomValidity("")}),3e3);y.nickname=t.value,y.clientId=generateUUID(),g=L(),a.children[0].onclick=null}})),document.querySelector("#entryForm button").addEventListener("click",(()=>{if(document.getElementById("nicknameInput").value.includes("#login"))return document.querySelector("#entryForm").removeAttribute("style"),void(document.getElementById("loginForm").style.display="flex")})),document.getElementById("loginForm").addEventListener("submit",(e=>{e.preventDefault(),y.isAdmin=!0;const t=document.getElementById("usernameInput").value,n=document.getElementById("passwordInput").value;fetch("https://emreview.duckdns.org/api/chat/admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:n,avatar:y.avatar})}).then((e=>{if(e.ok)return e.json();throw new Error("Invalid login")})).then((e=>{y.clientId=e.clientId,y.nickname=e.nickname,y.avatar=e.avatar,y.adminToken=e.token,g=T(),localStorage.setItem("userData",JSON.stringify(y))})).catch((e=>{Toastify({text:e.message,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()}))})),document.querySelector(".info-icon").addEventListener("click",(function(){const e=document.querySelector(".info-sidebar"),t=this.querySelector("i");e.classList.toggle("show")?(t.classList.remove(),t.className="fa-solid fa-circle-info fa-bounce"):(t.classList.remove(),t.className="fa-regular fa-circle-info")})),document.getElementById("infoSetting").addEventListener("click",(()=>document.getElementById("topModal").classList.add("show"))),document.getElementById("infoTerms").addEventListener("click",(()=>{document.getElementById("chatTerms").classList.add("show"),p()})),document.getElementById("hideTerms").addEventListener("click",(()=>{const e=document.getElementById("chatTerms");e.scrollTo({top:0,behavior:"smooth"}),e.classList.remove("show")})),document.getElementById("closeInfo").addEventListener("click",(()=>p())),document.getElementById("toggleSidebar").addEventListener("click",(()=>{const e=document.querySelector(".chat-sidebar"),t=document.getElementById("toggleSidebar").querySelector("i");e.classList.toggle("show")?(t.classList.remove("fa-chevron-right"),t.classList.add("fa-chevron-left")):(t.classList.remove("fa-chevron-left"),t.classList.add("fa-chevron-right"),p())})),document.getElementById("closeAvatar").addEventListener("click",(()=>document.getElementById("avatars").classList.remove("show")));const f=()=>{document.getElementById("avatars").classList.add("show"),fetch("./asset/user_avatars/totalAvatars.txt").then((e=>e.text())).then((e=>{const t=document.getElementById("avatarElements");t.innerHTML="";const n=document.createElement("i");n.className="fa-light fa-circle-user",n.addEventListener("click",(()=>{y.avatar=null,document.querySelectorAll(".user-avatar").forEach((e=>{e.innerHTML="";const t=n.cloneNode(!0);t.style.cursor="pointer",t.onclick=()=>f(),e.appendChild(t)})),document.getElementById("avatars").classList.remove("show")}),{once:!0}),t.appendChild(n);e.trim().split("\n").forEach((e=>{const n=document.createElement("img");n.src=`asset/user_avatars/${e.trim()}`,n.alt=`Avatar${e}`,n.addEventListener("click",(()=>{y.avatar=e.replace("\\r",""),document.querySelectorAll(".user-avatar").forEach((e=>{const t=n.cloneNode(!0);t.style.cursor="pointer",t.onclick=()=>f(),e.innerHTML="",e.appendChild(t)})),document.getElementById("avatars").classList.remove("show")}),{once:!0}),t.appendChild(n)}))})).catch((e=>console.error("Lỗi:",e)))};document.querySelector("#entryForm .user-avatar i").addEventListener("click",(()=>f())),document.querySelector("#loginForm .user-avatar i").addEventListener("click",(()=>f())),document.getElementById("changeNickname").addEventListener("click",(()=>{t.style.display="flex",e.style.height="calc(80% - 70px)",document.getElementById("closeUpdatenn").addEventListener("click",(()=>{t.removeAttribute("style"),e.removeAttribute("style"),n.value="",a.children[0].removeAttribute("style"),a.children[0].onclick=null,a.children[1]?.remove()}),{once:!0});const o=document.createElement("i");o.className="fa-solid fa-rotate",o.id="changeAvtIcon",a.appendChild(o),a.children[0].style.cursor="pointer",a.children[0].onclick=()=>f()})),s.addEventListener("input",(()=>{s.style.height="auto",s.style.height=Math.min(s.scrollHeight,100)+"px"}));let h=null;const k={};document.getElementById("messageForm").addEventListener("submit",(e=>{if(e.preventDefault(),!y||""===!y.clientId||""===y.nickname.trim()){const e=document.querySelector(".chat-sidebar");return e.style.width="100%",e.classList.add("show"),void document.querySelector(".chat-sidebar").classList.add("show")}if(""===s.value.trim()||s.value.length>500)return;k.id=(Math.random()+1).toString(36).substring(7),k.content=s.value,k.time=(new Date).toLocaleString(),h&&(k.replyTo=h);const t=null===y.avatar,n=(y.isAdmin?t||y.avatar:t||y.avatar,document.createElement("div"));n.className="message-element right",n.setAttribute("data-message-id",k.id),n.innerHTML=`\n                  <div class="msg-time">\n                    <i class="fa-regular fa-clock"></i>\n                    <span>${k.time}</span>\n                  </div>\n                  <div class="message-bottom">\n                    <div onclick="toggleDetails(this)" class="msg-content">\n                      <div class="msg-content-menu">\n                        <i class="fa-regular fa-reply"></i>\n                        <i class="fa-regular fa-copy"></i>\n                        <i class="fa-regular fa-trash"></i>\n                      </div>\n                      <p>\n                        ${k.content}\n                      </p>\n                    </div>\n                  </div>`,o.appendChild(n);const a={...k};a.replyTo&&B(!0,n,a.replyTo);n.querySelector(":scope .msg-content-menu .fa-reply").onclick=()=>{h={replier:y.clientId,sender:y.clientId,id:a.id,content:a.content};const e=document.createElement("div");e.className="message-reply-element",e.innerHTML=`<p><i class="fa-regular fa-turn-down-right"></i> "${a.content}"</p>`;const t=document.getElementById("messageForm");t.querySelector(":scope .message-reply-element")?.remove(),document.getElementById("messageForm").appendChild(e);const n=document.createElement("i");n.className="fa-regular fa-circle-xmark",n.onclick=function(){h=null,this.parentElement.remove()},e.appendChild(n)};n.querySelector(":scope .fa-copy").onclick=function(){this.className="fa-regular fa-check",setTimeout((()=>this.className="fa-regular fa-copy"),1500),copyToClipboardLegacy(a.content)};const i=n.querySelector(":scope .fa-trash");let c;i.addEventListener("click",(()=>{let e=Date.now();clearTimeout(c),c=setTimeout((()=>Toastify({text:E.double_click_to_unsend,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()),700),i.addEventListener("click",(()=>{Date.now()<e+250&&(clearTimeout(c),g?.unsendMessage(y.clientId,a.id))}),{once:!0})})),s.removeAttribute("style"),o.scrollHeight-o.scrollTop-40>=o.clientHeight+20&&o.scrollTo({top:o.scrollHeight,behavior:"smooth"})}));let E={};async function I(e){const t=document.querySelectorAll("[data-translate-key]"),n=await async function(e){try{const t=await fetch("./asset/en-vi.json");if(!t.ok)throw new Error(`Language file not found: ${e}`);const n=await t.json();return E=n[e].javascript_trans,n[e]||{}}catch(e){return console.error(e),{}}}(e);t.forEach((e=>{const t=e.getAttribute("data-translate-key");n[t]&&(e.matches("input")?(e.placeholder=n[t][0],e.title=n[t][1]??"No title"):e.innerHTML=n[t])}))}function T(){const t=new SocketHandler("wss://emreview.duckdns.org");t.onConnect((()=>{console.log("Connected to websocket server (socket.io)")}));let a,i,c,r=0;t.onConnectError((e=>{r++,r>=5&&(t.disConnect(),document.querySelector(".chat-box").classList.remove("open")),Toastify({text:e.message,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()}));const l=(e,n,s)=>{a=e,i=n,c=null===s?'<i class="fa-light fa-circle-user"></i>':`<img src="asset/user_avatars/${s}" alt="avatar" />`,document.querySelector(".chat-sidebar").classList.remove("show"),t.adminSelectClient(a,(e=>{o.innerHTML="",e.forEach((e=>{b(e,c,i)}))}))},d={clientId:y.clientId,token:y.adminToken};let m;t.joinAsAdmin(d,(t=>{if(t.success){y.clientId=t.adminData.clientId,y.nickname=t.adminData.nickname,y.avatar=t.adminData.avatar,localStorage.setItem("userData",JSON.stringify(y));let n=`<img src="asset/${null===y.avatar?"avatar.jpg":`user_avatars/${y.avatar}`}" alt="avatar" />`;document.querySelector("#userSidebar .user-avatar").innerHTML=n,document.getElementById("userNickname").textContent=y.nickname,document.getElementById("loginForm").removeAttribute("style"),document.getElementById("userSidebar").removeAttribute("style"),e.style.display="block";document.querySelector(".chat-sidebar").removeAttribute("style");const a=document.getElementById("uuidList");a.innerHTML="",t.clientData.forEach((e=>{const t=document.createElement("p");t.textContent=e.nickname,t.addEventListener("click",(()=>{l(e.clientId,e.nickname,e.avatar)})),a.appendChild(t)}))}else localStorage.removeItem("userData"),document.getElementById("userSidebar").style.display="none",document.querySelector("#entryForm").removeAttribute("style"),document.getElementById("loginForm").style.display="flex",Toastify({text:t.message,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()})),t.onUserUpdated((e=>{const t=document.getElementById("uuidList");t.innerHTML="",e.forEach((e=>{const n=document.createElement("p");n.textContent=e.nickname,n.addEventListener("click",(()=>{l(e.clientId,e.nickname,e.avatar)})),t.appendChild(n)}))})),s.addEventListener("input",(()=>{t.adminTyping({sender:a,isTyping:!0}),clearTimeout(m),m=setTimeout((()=>{t.adminTyping({sender:a,isTyping:!1})}),3e3)})),s.addEventListener("blur",(()=>{clearTimeout(m),t.adminTyping({sender:a,isTyping:!1})})),document.getElementById("messageForm").addEventListener("submit",(e=>{if(e.preventDefault(),y&&""!==!y.clientId&&""!==y.nickname.trim()&&""!==s.value.trim()&&!(s.value.length>500)){if(!a)return Toastify({text:E.select_an_client,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast(),void o.querySelector(":scope .right")?.remove();k.clientId=a,t.adminSendMessage(k),s.value="",document.querySelector("#messageForm .message-reply-element")?.remove(),h=null,delete k.replyTo}})),t.onUserTyping((e=>{e.sender===a&&(e.isTyping?S(c,i):o.querySelector(":scope .left.typing")?.remove())})),t.onUserMessage((e=>{e.sender===a&&w(e,c,i)})),document.getElementById("updateNicknameForm").addEventListener("submit",(e=>{e.preventDefault();const t={clientId:y.clientId,nickname:n.value,avatar:y.avatar};fetch("/api/chat/changenickname",{method:"POST",headers:{"Content-type":"application/json",authorization:`bearer ${y.adminToken}`},body:JSON.stringify(t)}).then((e=>{if(e.ok)return e.json();throw new Error("Invalid data")})).then((e=>{y.nickname=e.nickname,y.avatar=e.avatar,localStorage.setItem("userData",JSON.stringify(y)),Toastify({text:e.message,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()})).catch((e=>{Toastify({text:e.message,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()}))})),t.onMessageUnsend((e=>{if(e.success){const t=document.querySelector(`[data-message-id="${e.messageId}"]`);t.querySelector(":scope .message-replied")?.remove(),t.querySelector(":scope .message-bottom .msg-content").innerHTML=`<p>${E.unsend_message}</p>`,t.querySelector(":scope .message-bottom .msg-content").classList.add("canceled")}else Toastify({text:e.message,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()}));return{unsendMessage:(e,n)=>{e=a,t.unsendMessage([e,n])}}}function L(){const i=new SocketHandler("wss://emreview.duckdns.org");i.onConnect((()=>{console.log("Connected to websocket server (socket.io)")}));let c=0;i.onConnectError((e=>{c++,c>=5&&(i.disConnect(),document.querySelector(".chat-box").classList.remove("open")),Toastify({text:e.message,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()}));const r={clientId:y.clientId,avatar:y.avatar,nickname:y.nickname,create:new Date};let l,d,m;i.registerUser(r,(e=>{y.nickname=e.firstData.userNickname,y.avatar=e.firstData.userAvatar,l=e.firstData.adminAvatar,d=e.firstData.adminNickname,localStorage.setItem("userData",JSON.stringify(y));let t=null===y.avatar?'<i class="fa-light fa-circle-user"></i>':`<img src="asset/user_avatars/${y.avatar}" alt="avatar" />`;document.querySelector("#userSidebar .user-avatar").innerHTML=t,document.getElementById("userNickname").textContent=y.nickname,document.getElementById("entryForm").removeAttribute("style"),document.getElementById("userSidebar").removeAttribute("style");const n=document.querySelector(".chat-sidebar");n.removeAttribute("style"),n.classList.remove("show"),l=`<img src="asset/${null===l?"avatar.jpg":`user_avatars/${l}`}" alt="avatar" />`,o.innerHTML="",e.messages.forEach((e=>{b(e,l,d)}))})),s.addEventListener("input",(()=>{i.userTyping({sender:y.clientId,isTyping:!0}),clearTimeout(m),m=setTimeout((()=>{i.userTyping({sender:y.clientId,isTyping:!1})}),3e3)})),s.addEventListener("blur",(()=>{clearTimeout(m),i.userTyping({sender:y.clientId,isTyping:!1})})),document.getElementById("messageForm").addEventListener("submit",(e=>{e.preventDefault(),!y||""===!y.clientId||""===y.nickname.trim()||""===s.value.trim()||s.value.length>500||(i.userSendMessage(k),s.value="",document.querySelector("#messageForm .message-reply-element")?.remove(),h=null,delete k.replyTo)})),i.onAdminTyping((e=>{e?S(l,d):o.querySelector(":scope .left.typing")?.remove()})),i.onAdminMessage((e=>{w(e,l,d)})),document.getElementById("updateNicknameForm").addEventListener("submit",(o=>{o.preventDefault();let s=n.value;if(s===y.nickname&&y.avatar===JSON.parse(localStorage.getItem("userData")).avatar)return;if(""===s.trim()&&(s=y.nickname),s.toLowerCase().includes("admin"))return n.setCustomValidity(E.verifyNickname_1),n.reportValidity(),void setTimeout((()=>{n.setCustomValidity("")}),3e3);if(s.length>25)return n.setCustomValidity(E.verifyNickname_2),n.reportValidity(),void setTimeout((()=>{n.setCustomValidity("")}),3e3);if(s.toLowerCase().includes("thượng"))return n.setCustomValidity(E.verifyNickname_3),n.reportValidity(),void setTimeout((()=>{n.setCustomValidity("")}),3e3);const c={clientId:y.clientId,newNickname:s.trim(),newAvatar:y.avatar};i.updateNickname(c,(o=>{o.success&&(y.nickname=c.newNickname,localStorage.setItem("userData",JSON.stringify(y)),document.getElementById("userNickname").textContent=y.nickname,t.removeAttribute("style"),e.removeAttribute("style"),n.value="",a.children[0].removeAttribute("style"),a.children[0].onclick=null,a.children[1]?.remove()),Toastify({text:E[o.message],duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()}))})),i.onMessageUnsend((e=>{if(e.success){const t=document.querySelector(`[data-message-id="${e.messageId}"]`);t.querySelector(":scope .message-replied")?.remove(),t.querySelector(":scope .message-bottom .msg-content").innerHTML=`<p>${E.unsend_message}</p>`,t.querySelector(":scope .message-bottom .msg-content").classList.add("canceled")}else Toastify({text:e.message,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()}));return{unsendMessage:(e,t)=>{i.unsendMessage([e,t])}}}function b(e,t,n){if(e.sender===y.clientId){const t=document.createElement("div");t.className="message-element right",t.setAttribute("data-message-id",e.id),t.innerHTML=`\n          <div class="msg-time">\n            <i class="fa-regular fa-clock"></i>\n            <span>${e.time}</span>\n          </div>\n          <div class="message-bottom">\n            <div onclick="toggleDetails(this)" class="msg-content${null===e.content?" canceled":""}">\n              ${null===e.content?`<p>${E.unsend_message}</p>`:`<div class="msg-content-menu">\n                <i class="fa-regular fa-reply"></i>\n                <i class="fa-regular fa-copy"></i>\n                <i class="fa-regular fa-trash"></i>\n              </div>\n              <p>\n                ${e.content}\n              </p>`}\n            </div>\n          </div>`,o.appendChild(t),e.replyTo&&B(!0,t,e.replyTo);const n=t.querySelector(":scope .msg-content-menu .fa-reply"),a=t.querySelector(":scope .fa-trash"),s=t.querySelector(":scope .fa-copy");if(n&&s&&a){let t;n.onclick=()=>{h={replier:y.clientId,sender:e.sender,id:e.id,content:e.content};const t=document.createElement("div");t.className="message-reply-element",t.innerHTML=`<p><i class="fa-regular fa-turn-down-right"></i> "${e.content}"</p>`;const n=document.getElementById("messageForm");n.querySelector(":scope .message-reply-element")?.remove(),document.getElementById("messageForm").appendChild(t);const a=document.createElement("i");a.className="fa-regular fa-circle-xmark",a.onclick=function(){h=null,this.parentElement.remove()},t.appendChild(a)},s.onclick=function(){this.className="fa-regular fa-check",setTimeout((()=>this.className="fa-regular fa-copy"),1500),copyToClipboardLegacy(e.content)},a.addEventListener("click",(()=>{let n=Date.now();clearTimeout(t),t=setTimeout((()=>Toastify({text:E.double_click_to_unsend,duration:3e3,gravity:"top",position:"center",style:{background:"var(--focus-highlight)",color:"var(--main-color-background)"}}).showToast()),700),a.addEventListener("click",(()=>{Date.now()<n+250&&(clearTimeout(t),g?.unsendMessage(y.clientId,e.id))}),{once:!0})}))}}else{const a=document.createElement("div");a.className="message-element left",a.setAttribute("data-message-id",e.id),a.innerHTML=`\n          <div class="msg-time">\n            <i class="fa-regular fa-clock"></i>\n            <span>${e.time}</span>\n          </div>\n          <div class="message-bottom">\n            <div onclick="toggleDetails(this)" class="msg-user">\n              ${t}\n            </div>\n            <div onclick="toggleDetails(this)" class="msg-content${null===e.content?" canceled":""}">\n            ${null===e.content?`<p>${E.unsend_message}</p>`:`<div class="msg-content-menu">\n              <i class="fa-regular fa-copy"></i>\n              <i class="fa-regular fa-reply"></i>\n            </div>\n            <p>\n              ${e.content}\n            </p>`}\n            </div>\n          </div>\n          <div class="msg-nickname">\n            <i class="fa-regular fa-tag"></i>\n            <span>${n}</span>\n          </div>`,o.appendChild(a),e.replyTo&&B(!1,a,e.replyTo);const s=a.querySelector(":scope .msg-content-menu .fa-reply"),i=a.querySelector(":scope .fa-copy");s&&i&&(s.onclick=()=>{h={replier:y.clientId,sender:e.sender,id:e.id,content:e.content};const t=document.createElement("div");t.className="message-reply-element",t.innerHTML=`<p><i class="fa-regular fa-turn-down-right"></i> "${e.content}"</p>`;const n=document.getElementById("messageForm");n.querySelector(":scope .message-reply-element")?.remove(),document.getElementById("messageForm").appendChild(t);const a=document.createElement("i");a.className="fa-regular fa-circle-xmark",a.onclick=function(){h=null,this.parentElement.remove()},t.appendChild(a)},i.onclick=function(){this.className="fa-regular fa-check",setTimeout((()=>this.className="fa-regular fa-copy"),1500),copyToClipboardLegacy(e.content)})}o.scrollTop=o.scrollHeight}function S(e,t){if(!o.querySelector(":scope .left.typing")){const n=document.createElement("div");n.className="message-element left typing",n.innerHTML=`\n            <div class="msg-time">\n              <i class="fa-regular fa-keyboard"></i>\n              <span>${E.typing}</span>\n            </div>\n            <div class="message-bottom">\n             <div onclick="toggleDetails(this)" class="msg-user">\n                ${e}\n              </div>\n              <div onclick="toggleDetails(this)" class="msg-content">\n                <i class="fa-solid fa-ellipsis fa-bounce"></i>\n              </div>\n            </div>\n            <div class="msg-nickname">\n              <i class="fa-regular fa-tag"></i>\n              <span>${t}</span>\n            </div>`,o.appendChild(n)}}function w(e,t,n){const a=document.createElement("div");a.className="message-element left",a.setAttribute("data-message-id",e.id),a.innerHTML=`\n                  <div class="msg-time">\n                    <i class="fa-regular fa-clock"></i>\n                    <span>${e.time}</span>\n                  </div>\n                  <div class="message-bottom">\n                    <div onclick="toggleDetails(this)" class="msg-user">\n                      ${t}\n                    </div>\n                    <div onclick="toggleDetails(this)" class="msg-content">\n                      <div class="msg-content-menu">\n                        <i class="fa-regular fa-copy"></i>\n                        <i class="fa-regular fa-reply"></i>\n                      </div>\n                      <p>\n                        ${e.content}\n                      </p>\n                    </div>\n                  </div>\n                  <div class="msg-nickname">\n                    <i class="fa-regular fa-tag"></i>\n                    <span>${n}</span>\n                  </div>`,o.appendChild(a),e.replyTo&&B(!1,a,e.replyTo);a.querySelector(":scope .msg-content-menu .fa-reply").onclick=()=>{h={replier:y.clientId,sender:e.sender,id:e.id,content:e.content};const t=document.createElement("div");t.className="message-reply-element",t.innerHTML=`<p><i class="fa-regular fa-turn-down-right"></i> "${e.content}"</p>`;const n=document.getElementById("messageForm");n.querySelector(":scope .message-reply-element")?.remove(),document.getElementById("messageForm").appendChild(t);const a=document.createElement("i");a.className="fa-regular fa-circle-xmark",a.onclick=function(){h=null,this.parentElement.remove()},t.appendChild(a)};a.querySelector(":scope .fa-copy").onclick=function(){this.className="fa-regular fa-check",setTimeout((()=>this.className="fa-regular fa-copy"),1500),copyToClipboardLegacy(e.content)},v?.sendNotification(n,e.content,"./asset/chatapp.png")}function B(e,t,n){const a=document.createElement("div");a.className="message-replied",a.innerHTML=`<span>\n                            <i class="fa-regular fa-reply"></i> ${e?n.replier===n.sender?E.you_replied_yourself:E.you_replied:n.replier===n.sender?E.self_replied:E.replied_you}</span>\n                            <p>${n.content}</p>`,t.insertBefore(a,t.childNodes[2]),a.onclick=()=>{const e=document.querySelector(`.message-element[data-message-id="${n.id}"]`);e&&(o.scrollTo({top:e.offsetTop-o.offsetTop,behavior:"smooth"}),e.classList.add("bulge"),setTimeout((()=>{e.classList.remove("bulge")}),1500))}}document.getElementById("english").addEventListener("click",(()=>{document.getElementById("selectedBackground").style.left="0",localStorage.setItem("use-language","en"),I("en")})),document.getElementById("vietnamese").addEventListener("click",(()=>{document.getElementById("selectedBackground").style.left="50%",localStorage.setItem("use-language","vi"),I("vi")})),document.getElementById("themeToggle").addEventListener("change",(function(){document.body.classList.toggle("dark-theme"),localStorage.setItem("theme",this.checked?"dark":"light")})),function(){"dark"===localStorage.getItem("theme")&&(document.getElementById("themeToggle").checked=!0,document.body.classList.add("dark-theme"));let e=localStorage.getItem("use-language");e||(e="vi"),I(e),document.getElementById("selectedBackground").style.left="en"===e?"0":"50%"}(),document.getElementById("scrollBottomBtn").addEventListener("click",(function(){o.scrollTo({top:o.scrollHeight,behavior:"smooth"}),this.classList.remove("show")})),o.addEventListener("scroll",throttle((()=>{o.scrollHeight-o.scrollTop-40>=o.clientHeight+150?document.getElementById("scrollBottomBtn").classList.add("show"):document.getElementById("scrollBottomBtn").classList.remove("show")})),100);new MutationObserver((()=>{o.scrollHeight-o.scrollTop-40<=o.clientHeight+20?o.scrollTo({top:o.scrollHeight,behavior:"smooth"}):document.getElementById("scrollBottomBtn").classList.add("show")})).observe(o,{childList:!0})})),window.toggleDetails=function(e){const t=e;t.classList.toggle("details")&&document.querySelectorAll(".details").forEach((e=>{e!=t&&e.classList.remove("details")}))};